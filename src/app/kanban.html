<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kanban Board — no∅</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../css/novoid.min.css">
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--nv-bg); color: var(--nv-text); font-family: var(--nv-font-sans); }

    .kb-header {
      height: 56px;
      padding: 0 var(--nv-space-6);
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--nv-border);
      background: var(--nv-bg);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .kb-logo {
      font-family: var(--nv-font-display);
      font-weight: 800;
      font-size: var(--nv-text-lg);
      display: flex;
      align-items: center;
      gap: var(--nv-space-2);
    }

    .kb-logo-mark {
      width: 28px; height: 28px;
      background: linear-gradient(135deg, var(--nv-primary-500), var(--nv-primary-700));
      border-radius: var(--nv-radius-md);
      display: grid; place-items: center;
      color: #fff; font-size: 14px; font-weight: 900;
    }

    .kb-board {
      display: flex;
      gap: var(--nv-space-4);
      padding: var(--nv-space-5);
      overflow-x: auto;
      min-height: calc(100vh - 56px);
      align-items: flex-start;
    }

    .kb-col {
      min-width: 300px; max-width: 320px; flex-shrink: 0;
      background: var(--nv-bg-subtle);
      border-radius: var(--nv-radius-xl);
      display: flex; flex-direction: column;
      max-height: calc(100vh - 80px);
    }

    .kb-col-head {
      padding: var(--nv-space-3) var(--nv-space-4);
      display: flex; align-items: center; justify-content: space-between;
    }

    .kb-col-title {
      font-family: var(--nv-font-display);
      font-weight: 700; font-size: var(--nv-text-sm);
      display: flex; align-items: center; gap: var(--nv-space-2);
    }

    .kb-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }

    .kb-count {
      background: var(--nv-bg-muted); color: var(--nv-text-muted);
      font-size: 11px; font-weight: 600;
      padding: 1px 7px; border-radius: var(--nv-radius-full);
    }

    .kb-cards {
      padding: 0 var(--nv-space-3) var(--nv-space-2);
      display: flex; flex-direction: column; gap: var(--nv-space-2);
      overflow-y: auto; flex: 1; min-height: 40px;
      transition: background var(--nv-duration-fast) var(--nv-ease);
      border-radius: var(--nv-radius-md);
      margin: 0 4px;
    }

    .kb-cards.drag-over {
      background: color-mix(in srgb, var(--nv-primary-500) 6%, transparent);
    }

    .kb-cards::-webkit-scrollbar { width: 4px; }
    .kb-cards::-webkit-scrollbar-thumb { background: var(--nv-border-strong); border-radius: 2px; }

    .kb-card {
      background: var(--nv-bg);
      border: 1px solid var(--nv-border);
      border-radius: var(--nv-radius-lg);
      padding: var(--nv-space-3) var(--nv-space-4);
      cursor: grab;
      transition: box-shadow var(--nv-duration-fast) var(--nv-ease),
                  border-color var(--nv-duration-fast) var(--nv-ease),
                  transform var(--nv-duration-fast) var(--nv-ease);
      position: relative;
    }

    .kb-card:hover { border-color: var(--nv-border-strong); box-shadow: var(--nv-shadow-sm); }
    .kb-card:active { cursor: grabbing; }
    .kb-card.dragging { opacity: 0.35; transform: scale(0.96); }

    .kb-card-title { font-weight: 600; font-size: var(--nv-text-sm); line-height: 1.4; margin-bottom: 2px; }
    .kb-card-desc { font-size: var(--nv-text-xs); color: var(--nv-text-muted); line-height: 1.5; }

    .kb-card-foot {
      display: flex; align-items: center; justify-content: space-between;
      margin-top: var(--nv-space-2);
    }

    .kb-pri {
      font-size: 10px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.05em; padding: 2px 8px;
      border-radius: var(--nv-radius-full);
    }
    .kb-pri-low { background: var(--nv-success-50); color: var(--nv-success-700); }
    .kb-pri-med { background: var(--nv-warning-50); color: var(--nv-warning-700); }
    .kb-pri-high { background: var(--nv-danger-50); color: var(--nv-danger-700); }

    .kb-acts {
      display: flex; gap: 2px; opacity: 0;
      transition: opacity var(--nv-duration-fast) var(--nv-ease);
    }
    .kb-card:hover .kb-acts { opacity: 1; }

    .kb-act {
      background: none; border: none; color: var(--nv-text-subtle);
      cursor: pointer; padding: 3px; border-radius: var(--nv-radius-sm);
      font-size: 13px; line-height: 1;
      transition: all var(--nv-duration-fast) var(--nv-ease);
    }
    .kb-act:hover { background: var(--nv-bg-muted); color: var(--nv-text); }

    .kb-placeholder {
      border: 2px dashed var(--nv-primary-300);
      border-radius: var(--nv-radius-lg);
      background: color-mix(in srgb, var(--nv-primary-50) 30%, transparent);
      min-height: 48px;
    }

    .kb-add-btn {
      width: 100%; padding: var(--nv-space-2) var(--nv-space-3);
      border: none; border-radius: var(--nv-radius-lg);
      background: transparent; color: var(--nv-text-muted);
      font-size: var(--nv-text-sm); font-weight: 500; cursor: pointer;
      text-align: left; font-family: inherit;
      display: flex; align-items: center; gap: var(--nv-space-2);
      transition: all var(--nv-duration-fast) var(--nv-ease);
      margin: 0 var(--nv-space-3) var(--nv-space-3);
    }
    .kb-add-btn:hover { background: var(--nv-bg-muted); color: var(--nv-text); }

    .kb-form {
      padding: 0 var(--nv-space-3) var(--nv-space-3);
    }

    .kb-form-inner {
      background: var(--nv-bg); border: 1px solid var(--nv-border);
      border-radius: var(--nv-radius-lg); padding: var(--nv-space-3);
    }

    .kb-form textarea {
      width: 100%; border: none; outline: none; resize: none;
      font-family: var(--nv-font-sans); font-size: var(--nv-text-sm);
      font-weight: 600; background: transparent; color: var(--nv-text);
      line-height: 1.4; min-height: 36px;
    }
    .kb-form textarea::placeholder { color: var(--nv-text-subtle); }
    .kb-form textarea.desc { font-weight: 400; font-size: var(--nv-text-xs); color: var(--nv-text-muted); min-height: 24px; margin-top: 4px; }

    .kb-add-col {
      min-width: 300px; flex-shrink: 0;
      padding: var(--nv-space-3); border: 2px dashed var(--nv-border);
      border-radius: var(--nv-radius-xl); background: transparent;
      color: var(--nv-text-muted); font-family: var(--nv-font-display);
      font-weight: 600; font-size: var(--nv-text-sm); cursor: pointer;
      text-align: center;
      transition: all var(--nv-duration-fast) var(--nv-ease);
    }
    .kb-add-col:hover { border-color: var(--nv-primary-300); color: var(--nv-primary-500); }

    .kb-modal-bg {
      position: fixed; inset: 0; background: rgba(0,0,0,0.45);
      backdrop-filter: blur(4px); display: grid; place-items: center;
      z-index: var(--nv-z-modal);
      opacity: 0; pointer-events: none;
      transition: opacity var(--nv-duration-fast) var(--nv-ease);
    }
    .kb-modal-bg.active { opacity: 1; pointer-events: all; }

    @media (max-width: 768px) {
      .kb-board { padding: var(--nv-space-3); gap: var(--nv-space-3); }
      .kb-col { min-width: 270px; }
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <script src="../js/novoid.min.js"></script>
  <script>
    const { signal, computed, effect, batch, h, mount, list } = Novoid;

    // ── Persistence ──
    const KEY = 'nv-kanban';

    function load() {
      try { const r = localStorage.getItem(KEY); if (r) return JSON.parse(r); } catch(e) {}
      return null;
    }

    function save(data) {
      try { localStorage.setItem(KEY, JSON.stringify(data)); } catch(e) {}
    }

    const defaults = [
      { id: 'c1', title: 'To Do', dot: 'var(--nv-primary-400)', cards: [
        { id: 'k1', title: 'Research competitors', desc: 'Analyze top 5 competitors and document findings', pri: 'med' },
        { id: 'k2', title: 'Design system audit', desc: 'Review current tokens and components', pri: 'high' },
        { id: 'k3', title: 'Write unit tests', desc: '', pri: 'low' },
      ]},
      { id: 'c2', title: 'In Progress', dot: 'var(--nv-warning-500)', cards: [
        { id: 'k4', title: 'Build dashboard layout', desc: 'Responsive grid with sidebar navigation', pri: 'high' },
        { id: 'k5', title: 'API integration', desc: 'Connect auth endpoints', pri: 'med' },
      ]},
      { id: 'c3', title: 'Review', dot: 'var(--nv-info-500)', cards: [
        { id: 'k6', title: 'Code review: auth module', desc: 'Security audit pending', pri: 'high' },
      ]},
      { id: 'c4', title: 'Done', dot: 'var(--nv-success-500)', cards: [
        { id: 'k7', title: 'Project kickoff', desc: 'Team meeting and scope definition', pri: 'low' },
        { id: 'k8', title: 'Set up CI pipeline', desc: '', pri: 'med' },
      ]},
    ];

    const [cols, setCols] = signal(load() || defaults);
    effect(() => save(cols()));

    // ── IDs ──
    let _id = Date.now();
    const uid = () => 'k' + (++_id);
    const cuid = () => 'c' + (++_id);

    // ── Drag state ──
    let dragId = null, dragFrom = null;

    // ── Card operations ──
    function addCard(colId, title, desc, pri) {
      setCols(cs => cs.map(c => c.id === colId
        ? { ...c, cards: [...c.cards, { id: uid(), title, desc: desc || '', pri: pri || 'med' }] }
        : c));
    }

    function removeCard(colId, cardId) {
      setCols(cs => cs.map(c => c.id === colId
        ? { ...c, cards: c.cards.filter(k => k.id !== cardId) } : c));
    }

    function updateCard(colId, cardId, upd) {
      setCols(cs => cs.map(c => c.id === colId
        ? { ...c, cards: c.cards.map(k => k.id === cardId ? { ...k, ...upd } : k) } : c));
    }

    function moveCard(fromCol, toCol, cardId, beforeId) {
      setCols(cs => {
        let card = null;
        const step1 = cs.map(c => {
          if (c.id === fromCol) {
            card = c.cards.find(k => k.id === cardId);
            return { ...c, cards: c.cards.filter(k => k.id !== cardId) };
          }
          return c;
        });
        if (!card) return cs;
        return step1.map(c => {
          if (c.id === toCol) {
            const arr = [...c.cards];
            const idx = beforeId ? arr.findIndex(k => k.id === beforeId) : -1;
            idx >= 0 ? arr.splice(idx, 0, card) : arr.push(card);
            return { ...c, cards: arr };
          }
          return c;
        });
      });
    }

    function addCol(title) {
      setCols(cs => [...cs, { id: cuid(), title, dot: 'var(--nv-gray-400)', cards: [] }]);
    }

    function removeCol(colId) { setCols(cs => cs.filter(c => c.id !== colId)); }
    function renameCol(colId, title) { setCols(cs => cs.map(c => c.id === colId ? { ...c, title } : c)); }

    // ── Edit modal state ──
    const [editing, setEditing] = signal(null);

    // ── Components ──

    function PriBadge(pri) {
      const lbl = { low: 'Low', med: 'Med', high: 'High' };
      return h('span', { class: `kb-pri kb-pri-${pri}` }, lbl[pri] || pri);
    }

    function Card(card, colId) {
      const el = h('div', {
        class: 'kb-card',
        draggable: 'true',
        onDragstart: (e) => {
          dragId = card.id;
          dragFrom = colId;
          el.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', card.id);
        },
        onDragend: () => {
          el.classList.remove('dragging');
          dragId = null; dragFrom = null;
          document.querySelectorAll('.kb-placeholder').forEach(p => p.remove());
        },
      },
        h('div', { class: 'kb-card-title' }, card.title),
        card.desc ? h('div', { class: 'kb-card-desc' }, card.desc) : null,
        h('div', { class: 'kb-card-foot' },
          PriBadge(card.pri),
          h('div', { class: 'kb-acts' },
            h('button', { class: 'kb-act', onClick: (e) => { e.stopPropagation(); setEditing({ colId, card: { ...card } }); } }, '✎'),
            h('button', { class: 'kb-act', onClick: (e) => { e.stopPropagation(); removeCard(colId, card.id); Novoid.toast.info('Card removed'); } }, '✕'),
          ),
        ),
      );
      return el;
    }

    function AddForm(colId) {
      const [open, setOpen] = signal(false);
      const [title, setTitle] = signal('');
      const [desc, setDesc] = signal('');
      const [pri, setPri] = signal('med');

      function submit() {
        const t = title().trim();
        if (!t) return;
        addCard(colId, t, desc().trim(), pri());
        batch(() => { setTitle(''); setDesc(''); setPri('med'); setOpen(false); });
        Novoid.toast.success('Card added');
      }

      return h('div', {},
        h('button', { class: 'kb-add-btn', show: () => !open(), onClick: () => setOpen(true) },
          h('span', { style: { fontSize: '16px', lineHeight: '1' } }, '+'), 'Add card'
        ),
        h('div', { show: open, class: 'kb-form' },
          h('div', { class: 'kb-form-inner' },
            h('textarea', {
              rows: 1, placeholder: 'Card title…',
              bind: [title, setTitle],
              onKeydown: (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); submit(); }
                if (e.key === 'Escape') setOpen(false);
              },
            }),
            h('textarea', {
              rows: 1, class: 'desc', placeholder: 'Description (optional)',
              bind: [desc, setDesc],
              onKeydown: (e) => { if (e.key === 'Escape') setOpen(false); },
            }),
          ),
          h('div', { class: 'nv-flex nv-items-center nv-justify-between nv-mt-2 nv-gap-2' },
            h('div', { class: 'nv-flex nv-gap-1' },
              ...['low', 'med', 'high'].map(p =>
                h('button', {
                  class: () => `kb-pri kb-pri-${p} nv-cursor-pointer`,
                  style: () => ({ outline: pri() === p ? '2px solid var(--nv-primary-400)' : 'none', outlineOffset: '1px' }),
                  onClick: () => setPri(p),
                }, p === 'low' ? 'Low' : p === 'med' ? 'Med' : 'High')
              )
            ),
            h('div', { class: 'nv-flex nv-gap-2' },
              h('button', { class: 'nv-btn nv-btn-ghost nv-btn-sm', onClick: () => batch(() => { setTitle(''); setDesc(''); setOpen(false); }) }, 'Cancel'),
              h('button', { class: 'nv-btn nv-btn-primary nv-btn-sm', onClick: submit }, 'Add'),
            ),
          ),
        ),
      );
    }

    function Col(col) {
      const cardsEl = h('div', { class: 'kb-cards' });
      let ph = null;

      function removePh() {
        if (ph && ph.parentNode === cardsEl) cardsEl.removeChild(ph);
        ph = null;
      }

      cardsEl.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        if (!dragId) return;
        cardsEl.classList.add('drag-over');
        if (!ph) { ph = document.createElement('div'); ph.className = 'kb-placeholder'; }
        const cards = [...cardsEl.querySelectorAll('.kb-card:not(.dragging)')];
        let placed = false;
        for (const c of cards) {
          const r = c.getBoundingClientRect();
          if (e.clientY < r.top + r.height / 2) { cardsEl.insertBefore(ph, c); placed = true; break; }
        }
        if (!placed) cardsEl.appendChild(ph);
      });

      cardsEl.addEventListener('dragleave', (e) => {
        if (!cardsEl.contains(e.relatedTarget)) { removePh(); cardsEl.classList.remove('drag-over'); }
      });

      cardsEl.addEventListener('drop', (e) => {
        e.preventDefault();
        cardsEl.classList.remove('drag-over');
        if (!dragId) return;
        const cards = [...cardsEl.querySelectorAll('.kb-card:not(.dragging)')];
        let beforeId = null;
        if (ph) {
          const next = ph.nextElementSibling;
          if (next && next.classList.contains('kb-card')) {
            const idx = cards.indexOf(next);
            const target = cols().find(c => c.id === col.id);
            if (target && target.cards[idx]) beforeId = target.cards[idx].id;
          }
        }
        removePh();
        moveCard(dragFrom, col.id, dragId, beforeId);
      });

      const colCards = computed(() => {
        const c = cols().find(x => x.id === col.id);
        return c ? c.cards : [];
      });

      const count = computed(() => colCards().length);

      list(cardsEl, colCards, k => k.id, (card) => Card(card, col.id));

      const [editingTitle, setEditingTitle] = signal(false);
      const [draft, setDraft] = signal(col.title);

      return h('div', { class: 'kb-col' },
        h('div', { class: 'kb-col-head' },
          h('div', { show: () => !editingTitle() },
            h('div', {
              class: 'kb-col-title nv-cursor-pointer',
              onDblclick: () => { setDraft(col.title); setEditingTitle(true); },
            },
              h('div', { class: 'kb-dot', style: { background: col.dot } }),
              col.title,
              h('span', { class: 'kb-count' }, () => String(count())),
            ),
          ),
          h('div', { show: editingTitle, class: 'nv-flex nv-gap-1 nv-items-center' },
            h('input', {
              class: 'nv-input nv-input-sm', style: { width: '120px' },
              bind: [draft, setDraft],
              onKeydown: (e) => {
                if (e.key === 'Enter') { const t = draft().trim() || col.title; renameCol(col.id, t); col.title = t; setEditingTitle(false); }
                if (e.key === 'Escape') setEditingTitle(false);
              },
            }),
            h('button', { class: 'kb-act', onClick: () => { const t = draft().trim() || col.title; renameCol(col.id, t); col.title = t; setEditingTitle(false); } }, '✓'),
          ),
          h('button', {
            class: 'kb-act', style: { fontSize: '15px' },
            onClick: () => {
              if (cols().length > 1) { removeCol(col.id); Novoid.toast.info('Column removed'); }
              else Novoid.toast.warning('Need at least one column');
            },
          }, '✕'),
        ),
        cardsEl,
        AddForm(col.id),
      );
    }

    function EditModal() {
      const [t, setT] = signal('');
      const [d, setD] = signal('');
      const [p, setP] = signal('med');

      effect(() => {
        const e = editing();
        if (e) batch(() => { setT(e.card.title); setD(e.card.desc || ''); setP(e.card.pri || 'med'); });
      });

      function save() {
        const e = editing();
        if (!e) return;
        updateCard(e.colId, e.card.id, { title: t(), desc: d(), pri: p() });
        setEditing(null);
        Novoid.toast.success('Card updated');
      }

      return h('div', {
        class: () => `kb-modal-bg ${editing() ? 'active' : ''}`,
        onClick: (e) => { if (e.target === e.currentTarget) setEditing(null); },
      },
        h('div', { class: 'nv-card', style: { width: '100%', maxWidth: '26rem' } },
          h('div', { class: 'nv-card-header nv-flex nv-items-center nv-justify-between' },
            h('h3', { class: 'nv-h5' }, 'Edit Card'),
            h('button', { class: 'kb-act', style: { fontSize: '18px' }, onClick: () => setEditing(null) }, '✕'),
          ),
          h('div', { class: 'nv-card-body' },
            h('div', { class: 'nv-field' },
              h('label', { class: 'nv-label' }, 'Title'),
              h('input', { class: 'nv-input', bind: [t, setT], onKeydown: (e) => { if (e.key === 'Enter') save(); } }),
            ),
            h('div', { class: 'nv-field' },
              h('label', { class: 'nv-label' }, 'Description'),
              h('textarea', { class: 'nv-textarea', rows: 3, bind: [d, setD] }),
            ),
            h('div', { class: 'nv-field' },
              h('label', { class: 'nv-label nv-mb-2' }, 'Priority'),
              h('div', { class: 'nv-flex nv-gap-2' },
                ...['low', 'med', 'high'].map(pr =>
                  h('button', {
                    class: () => `kb-pri kb-pri-${pr} nv-cursor-pointer`,
                    style: () => ({ outline: p() === pr ? '2px solid var(--nv-primary-400)' : 'none', outlineOffset: '1px', padding: '4px 12px', fontSize: '12px' }),
                    onClick: () => setP(pr),
                  }, pr === 'low' ? 'Low' : pr === 'med' ? 'Medium' : 'High')
                ),
              ),
            ),
          ),
          h('div', { class: 'nv-card-footer nv-flex nv-justify-end nv-gap-2' },
            h('button', { class: 'nv-btn nv-btn-secondary nv-btn-sm', onClick: () => setEditing(null) }, 'Cancel'),
            h('button', { class: 'nv-btn nv-btn-primary nv-btn-sm', onClick: save }, 'Save'),
          ),
        ),
      );
    }

    function AddColBtn() {
      const [open, setOpen] = signal(false);
      const [name, setName] = signal('');

      return h('div', { style: { flexShrink: '0' } },
        h('button', { class: 'kb-add-col', show: () => !open(), onClick: () => setOpen(true) }, '+ Add Column'),
        h('div', { show: open, style: { minWidth: '300px' } },
          h('div', { class: 'nv-card', style: { background: 'var(--nv-bg-subtle)', border: 'none' } },
            h('div', { class: 'nv-card-body' },
              h('input', {
                class: 'nv-input nv-mb-3', placeholder: 'Column name…',
                bind: [name, setName],
                onKeydown: (e) => {
                  if (e.key === 'Enter' && name().trim()) { addCol(name().trim()); batch(() => { setName(''); setOpen(false); }); }
                  if (e.key === 'Escape') batch(() => { setName(''); setOpen(false); });
                },
              }),
              h('div', { class: 'nv-flex nv-gap-2' },
                h('button', { class: 'nv-btn nv-btn-primary nv-btn-sm', onClick: () => { if (name().trim()) { addCol(name().trim()); batch(() => { setName(''); setOpen(false); }); } } }, 'Add'),
                h('button', { class: 'nv-btn nv-btn-ghost nv-btn-sm', onClick: () => batch(() => { setName(''); setOpen(false); }) }, 'Cancel'),
              ),
            ),
          ),
        ),
      );
    }

    function ThemeToggle() {
      const [dark, setDark] = signal(document.documentElement.getAttribute('data-theme') === 'dark');
      effect(() => document.documentElement.setAttribute('data-theme', dark() ? 'dark' : 'light'));
      return h('button', {
        class: 'nv-btn nv-btn-ghost nv-btn-icon nv-btn-sm',
        onClick: () => setDark(d => !d),
        title: 'Toggle theme',
      }, () => dark() ? '☀' : '☽');
    }

    // ── Mount ──
    mount('#app', () => {
      const board = h('div', { class: 'kb-board' });
      list(board, cols, c => c.id, (col) => Col(col));
      board.appendChild(AddColBtn());

      return h('div', {},
        h('header', { class: 'kb-header' },
          h('div', { class: 'kb-logo' },
            h('div', { class: 'kb-logo-mark' }, '▦'),
            'Kanban',
          ),
          h('div', { class: 'nv-flex nv-items-center nv-gap-2' },
            h('button', {
              class: 'nv-btn nv-btn-ghost nv-btn-sm',
              onClick: () => { if (confirm('Reset board to defaults?')) { setCols(defaults); Novoid.toast.info('Board reset'); } },
            }, 'Reset'),
            ThemeToggle(),
          ),
        ),
        board,
        EditModal(),
      );
    });
  </script>
</body>
</html>
